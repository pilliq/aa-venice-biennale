<!DOCTYPE html>
<html>

<head>
  <link rel="shortcut icon" href="./favicon.ico">
  <link rel="stylesheet" type="text/css" href="./main.css">
  <style>
    body {
      padding: 0;
      margin: 0;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      position: absolute;
    }
    #model {
      width: 100%;
      height: 100vh;
      background-color: #fff;
    }
  </style>
</head>

<body>
  <div id="on-load-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <p class="modal-intro-content">The philosophy of architecture is a branch of philosophy of art, dealing with
        aesthetic value of architecture, its
        semantics and relations with development of culture. Many philosophers and theoreticians frome Plato to Michel
        Foucault,
        Gilles Deleuze, Robert Venturi and Ludwig Wittgenstein have concerned thesemselves with the nature of
        architecture and
        whether or not architecture is distinguished from building.
      </p>
      <p class="modal-intro-content">The philosophy of architecture is a branch of philosophy of art, dealing with
        aesthetic value of architecture, its
        semantics and relations with development of culture. Many philosophers and theoreticians frome Plato to Michel
        Foucault,
        Gilles Deleuze, Robert Venturi and Ludwig Wittgenstein have concerned thesemselves with the nature of
        architecture and
        whether or not architecture is distinguished from building.
      </p>
      <p class="modal-intro-content">The philosophy of architecture is a branch of philosophy of art, dealing with
        aesthetic value of architecture, its
        semantics and relations with development of culture. Many philosophers and theoreticians frome Plato to Michel
        Foucault,
        Gilles Deleuze, Robert Venturi and Ludwig Wittgenstein have concerned thesemselves with the nature of
        architecture and
        whether or not architecture is distinguished from building.
      </p>
    </div>
  </div>
  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <a href="#">
      <div id="nav-content-block-img">
        <img src="media/navbar-stock1.png" id="nav-content-img">
      </div>
      <div id="nav-content-text">The philosophy of architecture is a branch of philosophy of art, dealing with
        aesthetic value of architecture, its
        semantics and relations with development of culture. Many philosophers and theoreticians frome Plato to Michel
        Foucault,
        Gilles Deleuze, Robert Venturi and Ludwig Wittgenstein have concerned thesemselves with the nature of
        architecture and
        whether or not architecture is distinguished from building.</div>
      <div id="block-text" style="width:50px;height:50px"></div>
      <div id="block" style="width:50px;height:50px"></div>
    </a>
  </div>
  <div id="main">
    <div id="model">
    </div>
  </div>
  <img src="media/logo.png" id="absolute-logo">
  <div id="footer">
    <div class="footer-text">Connections</div>
    <div class="footer-text">Explore Existing</div>
    <div class="footer-text">Prototypes Library</div>
    <div id="footer-about-text">About</div>
  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script type="text/javascript" src="./d3.min.js"></script>
  <script type="text/javascript" src="./openseadragon.min.js"></script>
  <script type="text/javascript" src="./openseadragon-svg-overlay.js"></script>
  <script type="text/javascript" defer>
    var modal = document.getElementById("on-load-modal");
    var modal_close = document.getElementsByClassName("modal-close")[0];
    modal_close.onclick = function () {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = e => {
      if (e.target == modal) {
        modal.style.display = "none";
      }
    }
    const openNav = () => document.getElementById("mySidenav").style.width = "28%"
    const closeNav = () => document.getElementById("mySidenav").style.width = "0"

    async function init() {
      const editMode = false
      let mouseNavEnabled = !editMode
      let showAll = false

      const viewer = OpenSeadragon({
        id: 'model',
        prefixUrl: './model_files/',
        tileSources: './model.dzi',

        showNavigationControl: false,
        showZoomControl: false,
        showFullPageControl: false,

        animationTime: 1,
        springStiffness: 30,
        zoomPerClick: 1, // effectively disable click to zoom

        // disabled when in edit mode
        mouseNavEnabled,
      })
      const overlay = d3.select(viewer.svgOverlay().node())
      $(window).resize(() => viewer.svgOverlay().resize())

      const setMatrix = (selection, mat) => {
        selection.attr('transform', `matrix(${mat.a},${mat.b},${mat.c},${mat.d},${mat.e},${mat.f})`)
      }

      //const data = await d3.xml('./connections-outlines-small-inline.svg')
      const data = await d3.xml('./outlines.svg')
      const map = overlay.append('g')
      d3.select(data).selectAll('g')
        .each(function() {
          map.node().appendChild(this)
        })
      // Quadrant selector for elements with ids like '#Outline_x5F_Anna'
      d3.selectAll('[id^="Outline_x5F_"]')
        .style('visibility', 'hidden')
        .style('pointer-events', 'all')
        .on('mouseover', function() { d3.select(this).style('visibility', 'visible') })
        .on('mouseout', function() { d3.select(this).style('visibility', 'hidden') })
        .on('click', function() {
          console.log('click')
        })

      // Set overlays to manually-determined position
      let mat = overlay.node().getScreenCTM().inverse()
      map.attr('transform', 'matrix(0.0014075787724075425,0,0,0.0014075787724075425,0.1329509883327092,0.014575898199770098)')
      mat = map.node().transform.baseVal.consolidate().matrix

      // Edit tools
      if (editMode) {
        const svg = d3.select(overlay.node().parentNode)
        map.call(
          d3.drag()
            .on('drag', function() {
              const pt = svg.node().createSVGPoint()
              pt.x = d3.event.x
              pt.y = d3.event.y
              const tpt = pt.matrixTransform(mat.inverse()) // transformed point
              mat = mat.translate(tpt.x, tpt.y)
              setMatrix(d3.select(this), mat)
              console.log(this)
            })
        )
        document.addEventListener('keydown', e => {
          if (e.code === 'ArrowUp') {
            mat = mat.scale(1.01)
            setMatrix(map, mat)
            console.log(map.node())
          }
          if (e.code === 'ArrowDown') {
            mat = mat.scale(.99)
            setMatrix(map, mat)
            console.log(map.node())
          }
          if (e.code === 'KeyE') {
            mouseNavEnabled = !mouseNavEnabled
            viewer.setMouseNavEnabled(mouseNavEnabled)
            console.log(map.node())
          }
          if (e.code === 'KeyW') {
            mat = mat.translate(0,-.5)
            setMatrix(map, mat)
            console.log(map.node())
          }
          if (e.code === 'KeyS') {
            mat = mat.translate(0,.5)
            setMatrix(map, mat)
            console.log(map.node())
          }
          if (e.code === 'KeyA') {
            mat = mat.translate(-.5,0)
            setMatrix(map, mat)
            console.log(map.node())
          }
          if (e.code === 'KeyD') {
            mat = mat.translate(.5,0)
            setMatrix(map, mat)
            console.log(map.node())
          }
          if (e.code === 'KeyT') {
            if (showAll) {
              d3.selectAll('[id^="Outline_x5F_"]')
                .style('visibility', 'hidden')
                .style('pointer-events', 'all')
              showAll = false
            } else {
              d3.selectAll('[id^="Outline_x5F_"]')
                .style('visibility', 'visible')
                .style('pointer-events', 'none')
              showAll = true
            }
          }
        })
      }
    }
    $(document).ready(() => init())
  </script>
</body>

</html>
